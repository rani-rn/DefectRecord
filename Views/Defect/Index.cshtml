@{
    ViewData["Title"] = "Home Page";
}

<style>
    .container {
        display: flex;
        flex-direction: column;
    }

    #chart {
        max-width: 800px;
        max-height: 400px;
        width: 100%;
        height: auto;
        margin: auto;
    }

    .chart-container {
        width: 600px;
        max-width: 100%;
        height: 400px;
        padding-top: 0px;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .mb-3 {
        padding-bottom: 0%;
    }
</style>
<div class="container">
    <h2 class="text-header">Dashboard</h2>

    <div class="mb-3">
        <label for="lineProductionFilter" class="form-label">Filter by Line Production</label>
        <select id="lineProduction" name="LineProductionId" class="form-control">
            <option value="">All Line Production</option>
            @foreach (var line in (ViewBag.LineProductions ?? new List<LineProduction>()))
            {
                <option value="@line.Id">@line.LineProductionName</option>
            }
        </select>
    </div>

    <div class="chart-container">
        <canvas id="chart"></canvas>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            let chartInstance = null;

            function loadChart(lineProductionId = '') {
                $.ajax({
                    url: '@Url.Action("GetChartData", "Defect")',
                    type: 'GET',
                    data: { lineProductionId: lineProductionId },
                    success: function (data) {
                        const labels = data.map(item => item.label);
                        const values = data.map(item => item.value);

                        if (chartInstance) {
                            chartInstance.destroy();
                        }

                        const ctx = document.getElementById("chart").getContext("2d");
                        chartInstance = new Chart(ctx, {
                            type: "bar",
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: "Defect Count",
                                    data: values,
                                    backgroundColor: "rgba(95, 246, 232, 0.8)",
                                    borderColor: "rgba(47, 163, 152, 0.8)",
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: {
                                    y: {
                                        beginAtZero: true
                                    }
                                }
                            }
                        });
                    },
                    error: function () {
                        console.error("Error loading chart data.");
                    }
                });
            }

            loadChart();

            $("#lineProduction").change(function () {
                let selectedLineProductionId = $(this).val();
                loadChart(selectedLineProductionId);
            });
        });
    </script>
}
